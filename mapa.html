<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Viagens dos Especialistas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #87CEEB 0%, #B0E0E6 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        input, select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #4682B4;
            box-shadow: 0 0 0 3px rgba(70, 130, 180, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4682B4, #5F9EA0);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(70, 130, 180, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .map-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            height: 600px;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .legend {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .legend h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #4682B4;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .popup-content {
            font-family: inherit;
        }

        .popup-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            border-bottom: 2px solid #4682B4;
            padding-bottom: 4px;
        }

        .popup-info {
            margin-bottom: 4px;
        }

        .popup-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-planejada { background: #ffd700; color: #333; }
        .status-em-andamento { background: #4caf50; color: white; }
        .status-concluida { background: #2196f3; color: white; }
        .status-cancelada { background: #f44336; color: white; }

        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #4682B4;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .form-row { grid-template-columns: 1fr; }
            .controls { padding: 15px; }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    </head>
    
<body>
    <div class="container">
        <div class="header">
            <h1>üó∫Ô∏è Mapa de Viagens dos Especialistas</h1>
            <p>Visualize e gerencie as viagens da sua equipe em tempo real</p>
        </div>

        <div class="controls">
            <h3 style="margin-bottom: 15px; color: #333;">üìã Adicionar Nova Viagem</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="especialista">Nome do Especialista</label>
                    <input type="text" id="especialista" placeholder="Ex: Jo√£o Silva">
                </div>
                <div class="form-group">
                    <label for="destino">Cidade de Destino</label>
                    <input type="text" id="destino" placeholder="Ex: S√£o Paulo, SP">
                </div>
                <div class="form-group">
                    <label for="proposito">Prop√≥sito da Viagem</label>
                    <select id="proposito">
                        <option value="">Selecione...</option>
                        <option value="Consultoria">Consultoria</option>
                        <option value="Treinamento">Treinamento</option>
                        <option value="Auditoria">Auditoria</option>
                        <option value="Confer√™ncia">Confer√™ncia</option>
                        <option value="Reuni√£o Cliente">Reuni√£o Cliente</option>
                        <option value="Suporte T√©cnico">Suporte T√©cnico</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status">
                        <option value="Planejada">Planejada</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Conclu√≠da">Conclu√≠da</option>
                        <option value="Cancelada">Cancelada</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="dataInicio">Data de In√≠cio</label>
                    <input type="date" id="dataInicio">
                </div>
                <div class="form-group">
                    <label for="dataFim">Data de Fim</label>
                    <input type="date" id="dataFim">
                </div>
                <div class="form-group">
                    <label for="empresa">Empresa/Cliente</label>
                    <input type="text" id="empresa" placeholder="Nome da empresa">
                </div>
                <div class="form-group" style="display: flex; align-items: end; gap: 10px;">
                    <button class="btn btn-primary" onclick="adicionarViagem()">‚ûï Adicionar Viagem</button>
                    <button class="btn btn-secondary" onclick="limparFormulario()">üóëÔ∏è Limpar</button>
                </div>
            </div>
        </div>

        <div class="controls">
            <h3 style="margin-bottom: 15px; color: #333;">üîç Filtros do Mapa</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="filtroEspecialista">Filtrar por Especialista</label>
                    <select id="filtroEspecialista" onchange="aplicarFiltros()">
                        <option value="">Todos os Especialistas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filtroStatus">Filtrar por Status</label>
                    <select id="filtroStatus" onchange="aplicarFiltros()">
                        <option value="">Todos os Status</option>
                        <option value="Planejada">Planejada</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Conclu√≠da">Conclu√≠da</option>
                        <option value="Cancelada">Cancelada</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filtroProposito">Filtrar por Prop√≥sito</label>
                    <select id="filtroProposito" onchange="aplicarFiltros()">
                        <option value="">Todos os Prop√≥sitos</option>
                        <option value="Consultoria">Consultoria</option>
                        <option value="Treinamento">Treinamento</option>
                        <option value="Auditoria">Auditoria</option>
                        <option value="Confer√™ncia">Confer√™ncia</option>
                        <option value="Reuni√£o Cliente">Reuni√£o Cliente</option>
                        <option value="Suporte T√©cnico">Suporte T√©cnico</option>
                    </select>
                </div>
                <div class="form-group" style="display: flex; align-items: end; gap: 10px;">
                    <button class="btn btn-secondary" onclick="limparFiltros()">üîÑ Limpar Filtros</button>
                    <button class="btn btn-primary" onclick="centralizarMapa()">üéØ Centralizar Mapa</button>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalViagens">0</div>
                <div class="stat-label">Total de Viagens</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="viagensAtivas">0</div>
                <div class="stat-label">Viagens Ativas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="especialistasAtivos">0</div>
                <div class="stat-label">Especialistas Ativos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="proximasViagens">0</div>
                <div class="stat-label">Pr√≥ximas Viagens</div>
            </div>
        </div>

        <div class="legend">
            <h3>üìç Legenda dos Status</h3>
            <div class="legend-item">
                <div class="legend-color" style="background: #ffd700;"></div>
                <span>Planejada</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #4caf50;"></div>
                <span>Em Andamento</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #2196f3;"></div>
                <span>Conclu√≠da</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f44336;"></div>
                <span>Cancelada</span>
            </div>
        </div>

        <div class="empty-state">
            <h3>Comece adicionando sua primeira viagem!</h3>
            <p>Preencha o formul√°rio acima para adicionar viagens ao mapa e acompanhar os deslocamentos da sua equipe.</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script>
        let map;
        let viagens = [];
        let markers = [];

        const supabaseUrl = "https://obwgegvrtxrlombmkaej.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9id2dlZ3ZydHhybG9tYm1rYWVqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NDcxOTMsImV4cCI6MjA2NDAyMzE5M30.0Ng21Ywqrm6eDqbclFyeOhARpJCyWvX7b-0dJLE1QwM";
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// Inicializar mapa
        function initMap() {
            map = L.map('map').setView([-14.2350, -51.9253], 4); // Centro do Brasil

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);
        }

        // Cores por status
        const coresStatus = {
            'Planejada': '#ffd700',
            'Em Andamento': '#4caf50',
            'Conclu√≠da': '#2196f3',
            'Cancelada': '#f44336'
        };

        // Fun√ß√£o para geocodificar endere√ßo (expandida)
        async function geocodificar(cidade) {
            // Normalizar entrada (remover acentos e converter para min√∫sculo)
            const cidadeNormalizada = cidade.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .trim();

            // Coordenadas de cidades brasileiras (busca flex√≠vel)
            const coordenadas = {
                // Capitais e principais cidades
                'sao paulo': [-23.5505, -46.6333],
                'sp': [-23.5505, -46.6333],
                'rio de janeiro': [-22.9068, -43.1729],
                'rj': [-22.9068, -43.1729],
                'brasilia': [-15.8267, -47.9218],
                'df': [-15.8267, -47.9218],
                'salvador': [-12.9714, -38.5014],
                'ba': [-12.9714, -38.5014],
                'fortaleza': [-3.7319, -38.5267],
                'ce': [-3.7319, -38.5267],
                'belo horizonte': [-19.9191, -43.9386],
                'mg': [-19.9191, -43.9386],
                'manaus': [-3.1190, -60.0217],
                'am': [-3.1190, -60.0217],
                'curitiba': [-25.4244, -49.2654],
                'pr': [-25.4244, -49.2654],
                'recife': [-8.0476, -34.8770],
                'pe': [-8.0476, -34.8770],
                'porto alegre': [-30.0346, -51.2177],
                'rs': [-30.0346, -51.2177],
                'goiania': [-16.6869, -49.2648],
                'go': [-16.6869, -49.2648],
                'belem': [-1.4558, -48.5044],
                'pa': [-1.4558, -48.5044],
                'guarulhos': [-23.4538, -46.5333],
                'campinas': [-22.9099, -47.0626],
                'sao luis': [-2.5297, -44.3028],
                'ma': [-2.5297, -44.3028],
                'sao goncalo': [-22.8268, -43.0535],
                'maceio': [-9.6658, -35.7353],
                'al': [-9.6658, -35.7353],
                'duque de caxias': [-22.7858, -43.3117],
                'natal': [-5.7945, -35.2110],
                'rn': [-5.7945, -35.2110],
                'teresina': [-5.0892, -42.8019],
                'pi': [-5.0892, -42.8019],
                'campo grande': [-20.4486, -54.6295],
                'ms': [-20.4486, -54.6295],
                'joao pessoa': [-7.1195, -34.8450],
                'pb': [-7.1195, -34.8450],
                'aracaju': [-10.9472, -37.0731],
                'se': [-10.9472, -37.0731],
                'florianopolis': [-27.5954, -48.5480],
                'sc': [-27.5954, -48.5480],
                'cuiaba': [-15.6014, -56.0979],
                'mt': [-15.6014, -56.0979],
                'vitoria': [-20.3155, -40.3128],
                'es': [-20.3155, -40.3128],
                'macapa': [0.0389, -51.0664],
                'ap': [0.0389, -51.0664],
                'boa vista': [2.8235, -60.6758],
                'rr': [2.8235, -60.6758],
                'rio branco': [-9.9750, -67.8243],
                'ac': [-9.9750, -67.8243],
                'palmas': [-10.1689, -48.3317],
                'to': [-10.1689, -48.3317],
                // Outras cidades importantes
                'uberlandia': [-18.9113, -48.2622],
                'sorocaba': [-23.5015, -47.4526],
                'santos': [-23.9618, -46.3322],
                'ribeirao preto': [-21.1775, -47.8100],
                'osasco': [-23.5329, -46.7918],
                'santo andre': [-23.6558, -46.5339],
                'sao bernardo do campo': [-23.6939, -46.5445],
                'campos dos goytacazes': [-21.7648, -41.3370],
                'nova iguacu': [-22.7592, -43.4513],
                'sao joao de meriti': [-22.8047, -43.3719],
                'betim': [-19.9681, -44.1982],
                'contagem': [-19.9317, -44.0538],
                'londrina': [-23.3045, -51.1696],
                'joinville': [-26.3044, -48.8487],
                'aparecida de goiania': [-16.8173, -49.2437],
                'ananindeua': [-1.3656, -48.3722],
                'porto velho': [-8.7612, -63.9039],
                'serra': [-20.1288, -40.3085],
                'niteroi': [-22.8831, -43.1036],
                'caxias do sul': [-29.1678, -51.1794],
                'vila velha': [-20.3297, -40.2925],
                'florianopolis': [-27.5969, -48.5495],
                'maua': [-23.6678, -46.4614],
                'carapicuiba': [-23.5226, -46.8357],
                'canoas': [-29.9177, -51.1804],
                'olinda': [-8.0089, -34.8553]
            };

            // Buscar coordenadas exatas
            let coord = coordenadas[cidadeNormalizada];
            if (coord) return coord;

            // Buscar por correspond√™ncia parcial
            for (let [key, value] of Object.entries(coordenadas)) {
                if (cidadeNormalizada.includes(key) || key.includes(cidadeNormalizada)) {
                    return value;
                }
            }

            // Se n√£o encontrar, retornar Bras√≠lia como padr√£o
            return [-15.8267, -47.9218];
        }

        // Fun√ß√£o para salvar dados no Supabase
async function salvarDadosNoSupabase(viagem) {
    const { data, error } = await supabase.from("viagens").insert([{
        especialista: viagem.especialista,
        destino: viagem.destino,
        proposito: viagem.proposito,
        status: viagem.status,
        data_inicio: viagem.dataInicio,
        data_fim: viagem.dataFim,
        empresa: viagem.empresa,
        latitude: viagem.coordenadas[0],
        longitude: viagem.coordenadas[1]
    }]);

    if (error) {
        console.error("Erro ao salvar no Supabase:", error);
    } else {
        viagem.id = data[0].id;
    }
}

// Fun√ß√£o para salvar dados no armazenamento local
        function salvarDados() {
            try {
                const dados = JSON.stringify(viagens);
                window.viagensData = dados; // Usar vari√°vel global em vez de localStorage
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
            }
        }

        // Fun√ß√£o para carregar dados do Supabase
async function carregarDadosDoSupabase() {
    const { data, error } = await supabase.from("viagens").select("*");
    if (error) {
        console.error("Erro ao carregar viagens:", error);
        return [];
    }
    return data.map(v => ({
        id: v.id,
        especialista: v.especialista,
        destino: v.destino,
        proposito: v.proposito,
        status: v.status,
        dataInicio: v.data_inicio,
        dataFim: v.data_fim,
        empresa: v.empresa,
        coordenadas: [v.latitude, v.longitude]
    }));
}

// Fun√ß√£o para carregar dados do armazenamento local
        function carregarDados() {
            try {
                if (window.viagensData) {
                    const dadosSalvos = JSON.parse(window.viagensData);
                    return dadosSalvos || [];
                }
                return [];
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                return [];
            }
        }

        // Adicionar viagem ao mapa
        async function adicionarViagem() {
            const especialista = document.getElementById('especialista').value;
            const destino = document.getElementById('destino').value;
            const proposito = document.getElementById('proposito').value;
            const status = document.getElementById('status').value;
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const empresa = document.getElementById('empresa').value;

            if (!especialista || !destino || !proposito) {
                alert('Por favor, preencha pelo menos o nome do especialista, destino e prop√≥sito.');
                return;
            }

            const coordenadas = await geocodificar(destino);
            
            const viagem = {
                id: Date.now(),
                especialista,
                destino,
                proposito,
                status,
                dataInicio,
                dataFim,
                empresa,
                coordenadas
            };

            viagens.push(viagem);
            adicionarMarcador(viagem);
            atualizarFiltroEspecialistas();
            atualizarEstatisticas();
            await salvarDadosNoSupabase(viagem);
            limparFormulario();
            
            // Esconder mensagem de estado vazio se houver viagens
            const emptyState = document.querySelector('.empty-state');
            if (viagens.length > 0) {
                emptyState.style.display = 'none';
            }
        }

        // Adicionar marcador no mapa
        function adicionarMarcador(viagem) {
            const cor = coresStatus[viagem.status];
            
            const marker = L.circleMarker(viagem.coordenadas, {
                color: cor,
                fillColor: cor,
                fillOpacity: 0.8,
                radius: 10,
                weight: 3
            });

            const popupContent = `
                <div class="popup-content">
                    <div class="popup-title">${viagem.especialista}</div>
                    <div class="popup-info"><strong>üìç Destino:</strong> ${viagem.destino}</div>
                    <div class="popup-info"><strong>üéØ Prop√≥sito:</strong> ${viagem.proposito}</div>
                    <div class="popup-info"><strong>üè¢ Empresa:</strong> ${viagem.empresa || 'N√£o informado'}</div>
                    <div class="popup-info"><strong>üìÖ Per√≠odo:</strong> ${formatarData(viagem.dataInicio)} - ${formatarData(viagem.dataFim)}</div>
                    <div class="popup-info">
                        <strong>Status:</strong> 
                        <span class="popup-status status-${viagem.status.toLowerCase().replace(' ', '-')}">${viagem.status}</span>
                    </div>
                    <div style="margin-top: 10px; text-align: center;">
                        <button onclick="excluirViagem(${viagem.id})" 
                                style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            üóëÔ∏è Excluir Viagem
                        </button>
                    </div>
                </div>
            `;

            marker.bindPopup(popupContent);
            marker.addTo(map);
            markers.push({ marker, viagem });
        }

        // Fun√ß√£o para excluir uma viagem
       async function excluirViagem(id) {
            if (confirm('Tem certeza que deseja excluir esta viagem?')) {
                await supabase.from("viagens").delete().eq("id", id);
        // Remover da lista de viagens
                viagens = viagens.filter(v => v.id !== id);
                
                // Remover marcador do mapa
                const markerIndex = markers.findIndex(m => m.viagem.id === id);
                if (markerIndex !== -1) {
                    map.removeLayer(markers[markerIndex].marker);
                    markers.splice(markerIndex, 1);
                }
                
                // Atualizar interface
                atualizarFiltroEspecialistas();
                atualizarEstatisticas();
                salvarDados(); // Salvar ap√≥s excluir
                
                // Mostrar mensagem de estado vazio se n√£o houver mais viagens
                const emptyState = document.querySelector('.empty-state');
                if (viagens.length === 0) {
                    emptyState.style.display = 'block';
                }
                
                // Fechar popup
                map.closePopup();
            }
        }

        // Formattar data
        function formatarData(data) {
            if (!data) return 'N√£o informado';
            return new Date(data + 'T00:00:00').toLocaleDateString('pt-BR');
        }

        // Atualizar estat√≠sticas
        function atualizarEstatisticas() {
            // Filtrar viagens vis√≠veis
            const viagensVisiveis = obterViagensVisiveis();
            
            const totalViagens = viagensVisiveis.length;
            const viagensAtivas = viagensVisiveis.filter(v => v.status === 'Em Andamento').length;
            const especialistasUnicos = [...new Set(viagensVisiveis.map(v => v.especialista))].length;
            const hoje = new Date();
            const proximasViagens = viagensVisiveis.filter(v => {
                if (!v.dataInicio) return false;
                const dataViagem = new Date(v.dataInicio + 'T00:00:00');
                return dataViagem > hoje && v.status === 'Planejada';
            }).length;

            document.getElementById('totalViagens').textContent = totalViagens;
            document.getElementById('viagensAtivas').textContent = viagensAtivas;
            document.getElementById('especialistasAtivos').textContent = especialistasUnicos;
            document.getElementById('proximasViagens').textContent = proximasViagens;
        }

        // Atualizar lista de especialistas no filtro
        function atualizarFiltroEspecialistas() {
            const select = document.getElementById('filtroEspecialista');
            const especialistasUnicos = [...new Set(viagens.map(v => v.especialista))].sort();
            
            // Limpar op√ß√µes existentes (exceto "Todos")
            select.innerHTML = '<option value="">Todos os Especialistas</option>';
            
            // Adicionar especialistas √∫nicos
            especialistasUnicos.forEach(especialista => {
                const option = document.createElement('option');
                option.value = especialista;
                option.textContent = especialista;
                select.appendChild(option);
            });
        }

        // Obter viagens que devem estar vis√≠veis baseado nos filtros
        function obterViagensVisiveis() {
            const filtroEspecialista = document.getElementById('filtroEspecialista').value;
            const filtroStatus = document.getElementById('filtroStatus').value;
            const filtroProposito = document.getElementById('filtroProposito').value;

            return viagens.filter(viagem => {
                if (filtroEspecialista && viagem.especialista !== filtroEspecialista) return false;
                if (filtroStatus && viagem.status !== filtroStatus) return false;
                if (filtroProposito && viagem.proposito !== filtroProposito) return false;
                return true;
            });
        }

        // Aplicar filtros ao mapa
        function aplicarFiltros() {
            const viagensVisiveis = obterViagensVisiveis();
            const viagensVisiveisIds = new Set(viagensVisiveis.map(v => v.id));

            // Mostrar/ocultar marcadores baseado nos filtros
            markers.forEach(({ marker, viagem }) => {
                if (viagensVisiveisIds.has(viagem.id)) {
                    marker.addTo(map);
                } else {
                    map.removeLayer(marker);
                }
            });

            // Atualizar estat√≠sticas
            atualizarEstatisticas();

            // Centralizar mapa nas viagens vis√≠veis se houver alguma
            if (viagensVisiveis.length > 0) {
                const coordenadas = viagensVisiveis.map(v => v.coordenadas);
                const grupo = L.featureGroup(markers
                    .filter(({ viagem }) => viagensVisiveisIds.has(viagem.id))
                    .map(({ marker }) => marker)
                );
                if (grupo.getLayers().length > 0) {
                    map.fitBounds(grupo.getBounds(), { padding: [20, 20] });
                }
            }
        }

        // Limpar todos os filtros
        function limparFiltros() {
            document.getElementById('filtroEspecialista').value = '';
            document.getElementById('filtroStatus').value = '';
            document.getElementById('filtroProposito').value = '';
            aplicarFiltros();
        }

        // Centralizar mapa em todas as viagens
        function centralizarMapa() {
            if (markers.length > 0) {
                const grupo = L.featureGroup(markers.map(({ marker }) => marker));
                map.fitBounds(grupo.getBounds(), { padding: [20, 20] });
            } else {
                map.setView([-14.2350, -51.9253], 4); // Centro do Brasil
            }
        }

        // Limpar formul√°rio
        function limparFormulario() {
            document.getElementById('especialista').value = '';
            document.getElementById('destino').value = '';
            document.getElementById('proposito').value = '';
            document.getElementById('status').value = 'Planejada';
            document.getElementById('dataInicio').value = '';
            document.getElementById('dataFim').value = '';
            document.getElementById('empresa').value = '';
        }

        // Carregar viagens salvas e recriar marcadores
       async function carregarViagens() {
            const viagensSalvas = await carregarDadosDoSupabase();
            viagens = viagensSalvas;
            
            // Recriar marcadores para cada viagem
            viagens.forEach(viagem => {
                adicionarMarcador(viagem);
            });
            
            // Atualizar interface
            atualizarFiltroEspecialistas();
            atualizarEstatisticas();
            
            // Controlar exibi√ß√£o da mensagem de estado vazio
            const emptyState = document.querySelector('.empty-state');
            if (viagens.length > 0) {
                emptyState.style.display = 'none';
            } else {
                emptyState.style.display = 'block';
            }
        }

        // Inicializar quando a p√°gina carregar
        window.onload = function() {
            initMap();
            carregarViagens(); // Carregar viagens salvas
        };
    </script>
</body>
</html>