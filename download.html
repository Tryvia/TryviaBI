<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(145deg, #1A237E 0%, #303F9F 100%); /* Existing dark blue gradient */
            min-height: 100vh;
            color: white;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: rgba(26, 35, 126, 0.9);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .logo-container {
            margin-bottom: 20px; /* Ajustado para melhor espa√ßamento com a nova logo */
            padding-bottom: 0px; /* Removido padding extra */
            border-bottom: none; /* Removido a borda */
            width: 100%;
            text-align: center;
        }

        /* Removido as regras para .logo e @keyframes pulse */
        /* Removido as regras para .sidebar h2 */

        /* Nova regra para sua logo personalizada */
        .your-custom-logo {
            width: 180px; /* MODIFICADO: Aumentado de 80px para 120px */
            height: auto; /* Mant√©m a propor√ß√£o da imagem */
            max-width: 100%; /* Garante que n√£o exceda o cont√™iner */
            display: block; /* Para centralizar se necess√°rio com margin auto */
            margin: 0 auto; /* Centraliza a imagem dentro do logo-container */
        }


        .nav-list {
            list-style: none;
            width: 100%;
        }

        .nav-item {
            margin: 10px 0;
            width: 100%;
        }

        .nav-item a, .nav-item button {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-size: 1.1em;
            border-radius: 8px;
            transition: background-color 0.3s ease, color 0.3s ease;
            width: 100%;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
        }

        .nav-item a:hover, .nav-item button:hover, .nav-item.active a, .nav-item.active button {
            background-color: rgba(0, 0, 0, 0.2);
            color: white;
            transform: translateX(5px); /* Small slide effect on hover */
        }

        .nav-item i {
            margin-right: 15px;
            font-size: 1.3em;
        }

        .main-content {
            margin-left: 250px;
            padding: 30px;
            flex-grow: 1;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 2.2em;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .profile-info {
            display: flex;
            align-items: center;
        }

        .profile-info img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            border: 3px solid #64B5F6;
        }

        .profile-info span {
            font-size: 1.1em;
            font-weight: bold;
            color: white;
        }

        .content-section {
            display: none;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            min-height: 70vh;
        }

        .content-section.active {
            display: block;
        }

        /* Forms */
        .form-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 30px;
            background-color: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px; /* Espa√ßamento entre form e grid/lista */
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.9);
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group input[type="number"],
        .form-group input[type="url"], /* Adicionado para o link do BI */
        .form-group select {
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            background-color: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 1em;
            transition: border-color 0.3s ease, background-color 0.3s ease;
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: #64B5F6;
            background-color: rgba(0, 0, 0, 0.4);
            outline: none;
        }

        .btn-primary, .btn-secondary {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 10px;
        }

        .btn-primary {
            background-color: #4CAF50; /* Green */
            color: white;
            box-shadow: 0 2px 5px rgba(0,128,0,0.5);
        }

        .btn-primary:hover {
            background-color: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #2196F3; /* Blue */
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,128,0.5);
        }

        .btn-secondary:hover {
            background-color: #1976D2;
            transform: translateY(-2px);
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s ease, background-color 0.3s ease;
            margin-top: 5px;
        }

        .upload-area:hover {
            border-color: #64B5F6;
            background-color: rgba(255, 255, 255, 0.05);
        }

        .upload-icon {
            font-size: 60px;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.8);
        }

        .upload-area p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1em;
        }

        /* Grids and Cards */
        .documents-grid, .clients-grid, .dashboards-grid { /* Adicionado .dashboards-grid */
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.1); /* Inner shadow for grid */
            min-height: 200px; /* Para mostrar o empty state */
        }

        .document-card, .client-card, .dashboard-card { /* Adicionado .dashboard-card */
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .document-card:hover, .client-card:hover, .dashboard-card:hover { /* Adicionado .dashboard-card */
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .document-header, .client-card-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .document-type, .client-status-card {
            background-color: #FFC107; /* Amber */
            color: #333;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: bold;
        }
        .client-status-card {
            background-color: #8BC34A; /* Light Green */
            color: white;
        }

        .delete-btn, .delete-btn-card {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2em;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .delete-btn:hover, .delete-btn-card:hover {
            color: #FF5252; /* Red accent */
        }

        .document-title, .client-name {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 5px;
            color: white;
        }

        .document-author, .client-email, .client-phone {
            font-size: 0.95em;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 10px;
        }

        .empty-state {
            grid-column: 1 / -1; /* Ocupa todas as colunas */
            text-align: center;
            padding: 50px 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.2em;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 20px;
            color: rgba(255, 255, 255, 0.4);
        }

        /* Clientes Tab Specifics */
        .client-tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .client-tab-button {
            padding: 15px 25px;
            border: none;
            background: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1em;
            cursor: pointer;
            transition: color 0.3s ease, border-bottom 0.3s ease;
            margin-right: 15px;
            border-bottom: 2px solid transparent;
        }

        .client-tab-button.active {
            color: white;
            border-bottom-color: #64B5F6;
            font-weight: bold;
        }

        .client-tab-button:hover {
            color: white;
        }

        .client-tab-content {
            display: none; /* Hidden by default */
        }
        
        #add-client .upload-area {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 150px;
            cursor: pointer;
        }

        #add-client .upload-area:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        #add-client .logo-preview {
            max-width: 100px;
            max-height: 100px;
            border-radius: 8px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        /* Products List */
        .products-section {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        .products-section h4 {
            margin-bottom: 15px;
            color: white;
        }
        .products-grid {
            display: flex; /* Changed to flex for better wrapping of items */
            flex-wrap: wrap; /* Allows items to wrap to the next line */
            gap: 15px;
        }
        .product-item {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 0.9em;
            white-space: nowrap; /* Prevents text from breaking */
        }
        .product-item .delete-btn {
            font-size: 1em;
            padding: 3px 6px;
            background-color: rgba(255, 0, 0, 0.5);
            border-radius: 50%;
            line-height: 1; /* For better vertical alignment of 'X' */
            color: white;
            transition: background-color 0.2s ease;
        }
        .product-item .delete-btn:hover {
            background-color: rgba(255, 0, 0, 0.8);
        }
        #productsList {
            margin-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 15px;
            display: none; /* Oculto por padr√£o, vis√≠vel quando h√° produtos */
        }

        /* Client Card Vertical (for view-clients tab) */
        .clients-grid {
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); /* Mais compacto */
        }
        .client-card-vertical {
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center; /* Centraliza o conte√∫do verticalmente */
            text-align: center;
            position: relative; /* Para posicionar o bot√£o de deletar */
        }

        .client-card-vertical:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .client-card-top {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Alinha o delete-btn e o status no topo */
            margin-bottom: 10px;
        }
        
        .delete-btn-card {
            background-color: rgba(255, 0, 0, 0.5); /* Fundo vermelho para o √≠cone de lixeira */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            color: white;
            font-size: 18px; /* Tamanho do √≠cone */
        }

        .delete-btn-card:hover {
            background-color: rgba(255, 0, 0, 0.8);
            transform: scale(1.1);
        }


        .client-logo-vertical {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3em;
            font-weight: bold;
            color: #64B5F6; /* Blue for initial letter */
            margin-bottom: 10px;
            overflow: hidden; /* **MUito importante para cortar o excesso da imagem** */
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .logo-preview-vertical {
            width: 100%; /* **Fazer a imagem preencher a largura do cont√™iner** */
            height: 100%; /* **Fazer a imagem preencher a altura do cont√™iner** */
            object-fit: cover; /* **Cortar a imagem para preencher o cont√™iner mantendo a propor√ß√£o** */
            border-radius: 50%; /* Manter o arredondamento */
        }

        .add-logo-text {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 10px;
        }

        .client-name-vertical {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 5px;
            color: white;
            word-break: break-word; /* Quebra palavras longas */
        }

        .client-status-text {
            font-size: 0.9em;
            color: #8BC34A; /* Light Green */
            margin-bottom: 15px;
        }

        .products-info-vertical {
            width: 100%;
            text-align: left;
            margin-bottom: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 15px;
        }

        .btn-vertical {
            padding: 10px 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            width: 90%; /* Ajusta a largura do bot√£o */
            margin-bottom: 10px; /* Espa√ßamento entre bot√µes */
        }

        .btn-vertical:hover {
            background-color: #1976D2;
            transform: translateY(-2px);
        }

        /* MODIFIED: Changed the "Editar Cliente" button to match the "Ver Documentos" button */
        .btn-vertical.edit {
            background-color: #2196F3; /* Blue, same as btn-vertical */
            color: white;
        }

        .btn-vertical.edit:hover {
            background-color: #1976D2; /* Darker blue, same as btn-vertical:hover */
        }

        /* Novas Regras para Dashboard */
        .dashboard-card {
            padding: 25px;
            background-color: rgba(0, 0, 0, 0.4);
            text-align: center;
            justify-content: flex-start; /* Alinha o conte√∫do ao topo */
        }

        .dashboard-card .client-logo-vertical { /* Reutiliza o estilo da logo do cliente */
            width: 100px; /* Um pouco maior que o dos clientes */
            height: 100px;
            margin: 0 auto 15px auto; /* Centraliza e adiciona margem inferior */
        }

        .dashboard-card h3 {
            font-size: 1.6em;
            margin-bottom: 15px;
            color: white;
        }

        .btn-bi {
            background-color: #673AB7; /* Deep Purple */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            text-decoration: none; /* Remover sublinhado do link */
            display: inline-flex; /* Para usar √≠cone e texto */
            align-items: center;
            gap: 10px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: auto; /* Empurra o bot√£o para o final do card */
        }

        .btn-bi:hover {
            background-color: #512DA8; /* Darker Deep Purple */
            transform: translateY(-2px);
        }


        /* Responsividade */
        @media (max-width: 992px) {
            .sidebar {
                width: 200px;
            }
            .main-content {
                margin-left: 200px;
                padding: 20px;
            }
            .header h1 {
                font-size: 1.8em;
            }
            .nav-item a, .nav-item button {
                font-size: 1em;
                padding: 10px 15px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: static;
                width: 100%;
                height: auto;
                flex-direction: row;
                justify-content: center;
                padding: 15px;
                border-right: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }
            .logo-container {
                display: block; /* Garante que o logo seja exibido no mobile */
                width: auto; /* Permite que o container se ajuste ao conte√∫do */
                text-align: center;
                margin-bottom: 15px;
            }
            .sidebar h2 {
                display: none;
            }
            .nav-list {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
            }
            .nav-item {
                margin: 5px;
                width: auto;
            }
            .nav-item a, .nav-item button {
                font-size: 0.9em;
                padding: 8px 12px;
            }
            .main-content {
                margin-left: 0;
                padding: 20px;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
                padding: 15px;
            }
            .header h1 {
                margin-bottom: 10px;
            }
            .form-row {
                flex-direction: column;
            }
            .documents-grid, .clients-grid, .dashboards-grid { /* Adicionado .dashboards-grid */
                grid-template-columns: 1fr;
                padding: 15px;
            }
            .client-tabs {
                flex-direction: column;
            }
            .client-tab-button {
                margin-bottom: 10px;
                margin-right: 0;
                text-align: center;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="sidebar">
        <div class="logo-container">
            <img src="logo1.png" alt="Sua Logo" class="your-custom-logo">
        </div>
         <li class="nav-item">
                <button onclick="showTab('dashboard')"><i class="fas fa-chart-line"></i> Dashboards</button>
            </li>
            <li class="nav-item">
                <button onclick="showTab('clients')"><i class="fas fa-users"></i> Clientes</button>
            </li>
            <li class="nav-item">
                <button onclick="window.location.href='https://tryvia.github.io/TryviaBI/mapa.html'"><i class="fas fa-calendar-check"></i> Visitas</button>
            <li class="nav-item active">
                <button onclick="showTab('documents')"><i class="fas fa-file-alt"></i> Time de Implanta√ß√£o</button>
            </li>
            <li class="nav-item">
                <a href="#"><i class="fas fa-cog"></i> Configura√ß√µes</a>
            </li>
            <li class="nav-item">
                <a href="#"><i class="fas fa-sign-out-alt"></i> Sair</a>
            </li>
        </ul>
    </div>

    <div class="main-content">
        <header class="header">
            <h1>Portal - Time de Implanta√ß√£o</h1>
            <div class="profile-info">
                <img src="tryvia.png" alt="Profile Picture">
                <span>Usu√°rio TRYVIA</span>
            </div>
        </header>

        <div id="documents" class="content-section active">
            <div class="form-container">
                <h3 style="margin-bottom: 20px;">Adicionar Novo Documento de Implanta√ß√£o</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="documentTitle">T√≠tulo</label>
                        <input type="text" id="documentTitle" placeholder="T√≠tulo do documento...">
                    </div>
                    <div class="form-group">
                        <label for="documentAuthor">Autor</label>
                        <input type="text" id="documentAuthor" placeholder="Nome do autor...">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="documentType">Tipo</label>
                        <select id="documentType">
                            <option value="">Selecione o tipo</option>
                            <option value="manual">Manual</option>
                            <option value="guia">Guia</option>
                            <option value="checklist">Checklist</option>
                            <option value="template">Template</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="documentFile">Arquivo</label>
                        <div class="upload-area" onclick="document.getElementById('documentFile').click()">
                            <div class="upload-icon">üìÑ</div>
                            <p>Arraste e solte ou clique para selecionar um arquivo</p>
                            <input type="file" id="documentFile" style="display: none;">
                        </div>
                    </div>
                </div>
                <button class="btn-primary" onclick="addDocument()">Adicionar Documento</button>
            </div>

            <h3 style="margin-top: 40px; margin-bottom: 20px;">Documentos Existentes</h3>
            <div id="documentsList" class="documents-grid">
                <div class="empty-state">
                    <div class="empty-state-icon">üìÅ</div>
                    <p>Nenhum documento encontrado</p>
                    <p>Adicione documentos para come√ßar</p>
                </div>
            </div>
        </div>

        <div id="clients" class="content-section">
            <div class="client-tabs">
                <button class="client-tab-button active" onclick="showClientTab('view-clients')">Visualizar Clientes</button>
                <button class="client-tab-button" onclick="showClientTab('add-client')">Adicionar Cliente</button>
                 <button class="client-tab-button" onclick="showClientTab('edit-client-tab')" style="display:none;" id="editClientTabButton">Editar Cliente</button>
            </div>

            <div id="view-clients" class="client-tab-content" style="display: block;">
                <h3 style="margin-bottom: 20px;">Lista de Clientes</h3>
                <div id="clientsList" class="clients-grid">
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <p>Nenhum cliente encontrado</p>
                        <p>Adicione clientes para come√ßar</p>
                    </div>
                </div>
            </div>

            <div id="add-client" class="client-tab-content" style="display: none;">
                <div class="form-container">
                    <h3 style="margin-bottom: 20px;">Adicionar Novo Cliente</h3>
                    <div class="form-row">
                        <div class="form-group" style="flex: 0 0 150px; text-align: center;">
                            <label>Logo do Cliente</label>
                            <div class="upload-area" onclick="document.getElementById('clientLogo').click()" id="logoPreview">
                                <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
                                <p>Clique para adicionar logo</p>
                                </div>
                            <input type="file" id="clientLogo" style="display: none;" onchange="previewLogo(this)">
                        </div>
                        <div class="form-group" style="flex: 2;">
                            <label for="clientName">Nome do Cliente</label>
                            <input type="text" id="clientName" placeholder="Nome completo ou da empresa...">
                            <label for="clientEmail" style="margin-top: 15px;">Email</label>
                            <input type="email" id="clientEmail" placeholder="email@exemplo.com">
                            <label for="clientPhone" style="margin-top: 15px;">Telefone</label>
                            <input type="tel" id="clientPhone" placeholder="(XX) XXXXX-XXXX">
                            <label for="clientBiLink" style="margin-top: 15px;">Link do Dashboard BI</label>
                            <input type="url" id="clientBiLink" placeholder="https://app.powerbi.com/dashboard/...">
                        </div>
                    </div>

                    <div class="products-section">
                        <h4>Produtos / Servi√ßos Associados</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productName">Nome do Produto/Servi√ßo</label>
                                <input type="text" id="productName" placeholder="Ex: Software SaaS, Consultoria...">
                            </div>
                            <div class="form-group" style="flex: 0 0 100px;">
                                <label for="productQuantity">Quantidade</label>
                                <input type="number" id="productQuantity" value="1" min="1">
                            </div>
                            <div class="form-group" style="flex: 0 0 120px; display: flex; align-items: flex-end;">
                                <button class="btn-secondary" onclick="addProduct()">Adicionar</button>
                            </div>
                        </div>
                        <div id="productsList">
                            <div id="productsContainer" class="products-grid">
                                <p style="color: rgba(255,255,255,0.7);">Nenhum produto adicionado ainda.</p>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn-primary" onclick="saveClient()" style="margin-top: 30px;">Salvar Cliente</button>
                </div>
            </div>

            <div id="edit-client-tab" class="client-tab-content" style="display: none;">
                <div class="form-container">
                    <h3 style="margin-bottom: 20px;">Editar Cliente</h3>
                    <input type="hidden" id="editClientId">

                    <div class="form-row">
                        <div class="form-group" style="flex: 0 0 150px; text-align: center;">
                            <label>Logo do Cliente</label>
                            <div class="upload-area" onclick="document.getElementById('editClientLogo').click()" id="editLogoPreview">
                                <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
                                <p>Clique para adicionar logo</p>
                                </div>
                            <input type="file" id="editClientLogo" style="display: none;" onchange="previewEditLogo(this)">
                        </div>
                        <div class="form-group" style="flex: 2;">
                            <label for="editClientName">Nome do Cliente</label>
                            <input type="text" id="editClientName" placeholder="Nome completo ou da empresa...">
                            <label for="editClientEmail" style="margin-top: 15px;">Email</label>
                            <input type="email" id="editClientEmail" placeholder="email@exemplo.com">
                            <label for="editClientPhone" style="margin-top: 15px;">Telefone</label>
                            <input type="tel" id="editClientPhone" placeholder="(XX) XXXXX-XXXX">
                            <label for="editClientBiLink" style="margin-top: 15px;">Link do Dashboard BI</label>
                            <input type="url" id="editClientBiLink" placeholder="https://app.powerbi.com/dashboard/...">
                        </div>
                    </div>

                    <div class="products-section">
                        <h4>Produtos / Servi√ßos Associados</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="editProductName">Nome do Produto/Servi√ßo</label>
                                <input type="text" id="editProductName" placeholder="Ex: Software SaaS, Consultoria...">
                            </div>
                            <div class="form-group" style="flex: 0 0 100px;">
                                <label for="editProductQuantity">Quantidade</label>
                                <input type="number" id="editProductQuantity" value="1" min="1">
                            </div>
                            <div class="form-group" style="flex: 0 0 120px; display: flex; align-items: flex-end;">
                                <button class="btn-secondary" onclick="addEditProduct()">Adicionar</button>
                            </div>
                        </div>
                        <div id="editProductsList">
                            <div id="editProductsContainer" class="products-grid">
                                <p style="color: rgba(255,255,255,0.7);">Nenhum produto adicionado ainda.</p>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn-primary" onclick="updateClient()" style="margin-top: 30px;">Atualizar Cliente</button>
                    <button class="btn-secondary" onclick="showClientTab('view-clients')" style="margin-top: 30px; margin-left: 10px;">Cancelar</button>
                </div>
            </div>

            <div id="view-client-documents" class="client-tab-content" style="display:none;">
            </div>

        </div>

        <div id="dashboard" class="content-section">
            <h3 style="margin-bottom: 20px;">Dashboards de Clientes</h3>
            <div id="dashboardsList" class="dashboards-grid">
                <div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <p>Nenhum Dashboard de cliente encontrado.</p>
                    <p>Adicione clientes com links de BI para visualiz√°-los aqui.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Inicialize o Supabase Client globalmente
        const SUPABASE_URL = 'https://mzjdmhgkrroajmsfwryu.supabase.co';
        // ATEN√á√ÉO: SUBSTITUA ESTA CHAVE PELA SUA CHAVE ANON/PUBLIC KEY DO SUPABASE REAL!
        // N√ÉO COLOQUE A CHAVE SERVICE_ROLE AQUI, POIS ELA √â SENS√çVEL!
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16amRtaGdrcnJvYWptc2Z3cnl1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgyMzMwMzUsImV4cCI6MjA2MzgwOTAzNX0.tQCwUfFCV7sD-IexQviU0XEPcbn9j5uK9NSUbH-OeBc'; 
        
        // Acessa a fun√ß√£o createClient do objeto global 'supabase' fornecido pela CDN
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Armazenamento de dados (ser√£o substitu√≠dos pelos dados do Supabase)
        let documents = [];
        let clients = [];
        let currentProducts = []; // Para adicionar novos clientes
        let editingProducts = []; // Para edi√ß√£o de clientes existentes

        // Fun√ß√µes que s√£o chamadas diretamente de atributos onclick no HTML ou por outras fun√ß√µes globais
        // DEVEM estar no escopo global (fora do DOMContentLoaded)

        function showTab(tabId) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            // O dashboard √© um link externo, n√£o um item com onclick que muda a tab diretamente
            const navItemToActivate = document.querySelector(`.nav-item button[onclick="showTab('${tabId}')"]`);
            if (navItemToActivate) {
                 navItemToActivate.parentElement.classList.add('active'); // Adiciona a classe ao <li> pai
            }


            // Renderiza o conte√∫do espec√≠fico da aba
            if (tabId === 'documents') {
                fetchAndRenderDocuments();
            } else if (tabId === 'clients') {
                // Ao ir para a aba de clientes, esconde o bot√£o de editar temporariamente
                document.getElementById('editClientTabButton').style.display = 'none';
                showClientTab('view-clients'); // Padr√£o para visualizar clientes ao abrir a aba de clientes
                fetchAndRenderClients();
            } else if (tabId === 'dashboard') { // NOVA ABA: DASHBOARD
                fetchAndRenderDashboards(); 
            }
        }

        function showClientTab(tabId) {
            document.querySelectorAll('.client-tab-content').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(tabId).style.display = 'block';

            // Atualiza os bot√µes da aba de cliente para marcar o ativo
            document.querySelectorAll('.client-tab-button').forEach(button => {
                button.classList.remove('active');
            });
            // Encontra o bot√£o correspondente e adiciona a classe 'active'
            const activeClientButton = document.querySelector(`.client-tab-button[onclick="showClientTab('${tabId}')"]`);
            if (activeClientButton) {
                activeClientButton.classList.add('active');
            }

            // Esconde o bot√£o "Editar Cliente" das abas de adi√ß√£o/visualiza√ß√£o, ele s√≥ aparece quando uma edi√ß√£o √© iniciada
            const editButton = document.getElementById('editClientTabButton');
            if (tabId === 'edit-client-tab') {
                editButton.style.display = 'block'; // Mostra se est√° na aba de edi√ß√£o
                editButton.classList.add('active'); // Marca como ativo
            } else {
                editButton.style.display = 'none'; // Esconde nas outras abas
                editButton.classList.remove('active');
            }


            if (tabId === 'view-clients') {
                fetchAndRenderClients();
            }
        }

        function previewLogo(input) {
            const logoPreview = document.getElementById('logoPreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    logoPreview.innerHTML = `<img src="${e.target.result}" class="logo-preview" alt="Logo preview">`;
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                // Se nenhum arquivo for selecionado, restaura o estado padr√£o
                logoPreview.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
                    <p>Clique para adicionar logo</p>
                `;
            }
        }

        function previewEditLogo(input) {
            const logoPreview = document.getElementById('editLogoPreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    logoPreview.innerHTML = `<img src="${e.target.result}" class="logo-preview" alt="Logo preview">`;
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                // Se nenhum arquivo for selecionado, tenta restaurar a logo atual se houver
                const clientId = document.getElementById('editClientId').value;
                const client = clients.find(c => c.id == clientId);
                if (client && client.logo_url) {
                    logoPreview.innerHTML = `<img src="${client.logo_url}" class="logo-preview" alt="Logo preview">`;
                } else {
                     logoPreview.innerHTML = `
                        <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
                        <p>Clique para adicionar logo</p>
                    `;
                }
            }
        }

        function addProduct() {
            const productName = document.getElementById('productName').value;
            const productQuantity = document.getElementById('productQuantity').value;

            if (productName && productQuantity > 0) {
                currentProducts.push({ name: productName, quantity: parseInt(productQuantity) });
                updateProductsList('currentProducts', 'productsContainer');
                document.getElementById('productName').value = '';
                document.getElementById('productQuantity').value = '1'; // Resetar para 1
                document.getElementById('productsList').style.display = 'block';
            } else {
                alert('Por favor, insira um nome e uma quantidade v√°lida para o produto.');
            }
        }

        function removeProduct(index, listType) {
            if (listType === 'currentProducts') {
                currentProducts.splice(index, 1);
                updateProductsList('currentProducts', 'productsContainer');
            } else if (listType === 'editingProducts') {
                editingProducts.splice(index, 1);
                updateProductsList('editingProducts', 'editProductsContainer');
            }
        }

        function addEditProduct() {
            const productName = document.getElementById('editProductName').value;
            const productQuantity = document.getElementById('editProductQuantity').value;

            if (productName && productQuantity > 0) {
                editingProducts.push({ name: productName, quantity: parseInt(productQuantity) });
                updateProductsList('editingProducts', 'editProductsContainer');
                document.getElementById('editProductName').value = '';
                document.getElementById('editProductQuantity').value = '1';
                document.getElementById('editProductsList').style.display = 'block';
            } else {
                alert('Por favor, insira um nome e uma quantidade v√°lida para o produto.');
            }
        }

        function updateProductsList(listName, containerId) {
            const productsToRender = listName === 'currentProducts' ? currentProducts : editingProducts;
            const productsContainer = document.getElementById(containerId);
            const productsListDiv = document.getElementById(containerId === 'productsContainer' ? 'productsList' : 'editProductsList');

            if (productsToRender.length === 0) {
                productsContainer.innerHTML = '<p style="color: rgba(255,255,255,0.7);">Nenhum produto adicionado ainda.</p>';
                productsListDiv.style.display = 'none';
                return;
            }
            
            productsListDiv.style.display = 'block'; 
            productsContainer.innerHTML = productsToRender.map((product, index) => `
                <div class="product-item">
                    <span>${product.name} (x${product.quantity})</span>
                    <button class="delete-btn" onclick="removeProduct(${index}, '${listName}')">X</button>
                </div>
            `).join('');
        }

        // A fun√ß√£o viewClientDocuments tamb√©m √© chamada diretamente do HTML
        async function viewClientDocuments(clientId) {
            const clientName = clients.find(c => c.id === clientId)?.name || `Cliente ID: ${clientId}`;
            
            let clientDocumentsSection = document.getElementById('view-client-documents');
            if (!clientDocumentsSection) {
                    // Criar a se√ß√£o dinamicamente se ela n√£o existir (caso a p√°gina seja carregada com um link direto para esta aba)
                const clientsDiv = document.getElementById('clients');
                clientsDiv.insertAdjacentHTML('beforeend', `<div id="view-client-documents" class="client-tab-content" style="display:none;"></div>`);
                clientDocumentsSection = document.getElementById('view-client-documents');
            }
            
            clientDocumentsSection.innerHTML = `
                <div class="form-container">
                    <h3 style="margin-bottom: 20px;">Documentos de: ${clientName}</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="clientDocumentTitle">T√≠tulo</label>
                            <input type="text" id="clientDocumentTitle" placeholder="T√≠tulo do documento...">
                        </div>
                        <div class="form-group">
                            <label for="clientDocumentType">Tipo</label>
                            <select id="clientDocumentType">
                                <option value="">Selecione o tipo</option>
                                <option value="apresentacao">Apresenta√ß√£o</option>
                                <option value="relatorio">Relat√≥rio</option>
                                <option value="atas">Atas</option>
                                <option value="planilha">Planilha</option>
                                <option value="outro">Outro</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="clientDocumentFile">Arquivo</label>
                            <div class="upload-area" onclick="document.getElementById('clientDocumentFile').click()">
                                <div class="upload-icon">üìÑ</div>
                                <p>Arraste e solte ou clique para selecionar um arquivo</p>
                                <input type="file" id="clientDocumentFile" style="display: none;">
                            </div>
                        </div>
                    </div>
                    <button class="btn-secondary" onclick="addClientDocument(${clientId})">Adicionar Documento ao Cliente</button>
                    <button class="btn-secondary" onclick="showClientTab('view-clients')" style="margin-left: 10px;">Voltar aos Clientes</button>
                </div>

                <h3 style="margin-top: 40px; margin-bottom: 20px;">Documentos Existentes</h3>
                <div id="clientDocumentsList" class="documents-grid">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÅ</div>
                        <p>Nenhum documento para este cliente.</p>
                    </div>
                </div>
            `;
            
            // Exibir a nova aba
            showClientTab('view-client-documents');
            
            // Carregar e renderizar os documentos espec√≠ficos deste cliente
            await fetchAndRenderClientDocuments(clientId);
        }

        // Fun√ß√µes para documentos
        async function addDocument() {
            const title = document.getElementById('documentTitle').value;
            const author = document.getElementById('documentAuthor').value;
            const type = document.getElementById('documentType').value;
            const fileInput = document.getElementById('documentFile');
            const file = fileInput.files[0];

            if (title && author && type && file) {
                const filePath = `${Date.now()}_${file.name}`;
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('documentfiles') // Nome do seu bucket de documentos
                    .upload(filePath, file);

                if (uploadError) {
                    console.error('Erro ao fazer upload do arquivo:', uploadError.message);
                    alert('Erro ao fazer upload do documento.');
                    return;
                }

                // Ajuste a URL p√∫blica para o formato correto do Supabase Storage v1
                // O formato deve ser: SUPABASE_URL/storage/v1/object/public/seu_bucket_name/caminho_do_arquivo
                const publicURL = `${SUPABASE_URL}/storage/v1/object/public/documentfiles/${filePath}`;

                const { data, error } = await supabase
                    .from('documents') // Nome da sua tabela de documentos
                    .insert([
                        { title, author, type, file_url: publicURL, file_path: filePath }
                    ]);

                if (error) {
                    console.error('Erro ao adicionar documento no banco de dados:', error.message);
                    alert('Erro ao adicionar documento.');
                } else {
                    alert('Documento adicionado com sucesso!');
                    // Limpar formul√°rio
                    document.getElementById('documentTitle').value = '';
                    document.getElementById('documentAuthor').value = '';
                    document.getElementById('documentType').value = '';
                    fileInput.value = ''; // Limpa o input de arquivo
                    fetchAndRenderDocuments(); // Re-renderiza os documentos do DB
                }
            } else {
                alert('Por favor, preencha todos os campos e selecione um arquivo.');
            }
        }

        async function fetchAndRenderDocuments() {
            const { data, error } = await supabase
                .from('documents')
                .select('*');

            const container = document.getElementById('documentsList');

            if (error) {
                console.error('Erro ao buscar documentos:', error.message);
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>Erro ao carregar documentos.</p></div>`;
                return;
            }

            documents = data; // Atualiza a vari√°vel local com os dados do Supabase

            if (documents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÅ</div>
                        <p>Nenhum documento encontrado</p>
                        <p>Adicione documentos para come√ßar</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = documents.map(doc => `
                <div class="document-card">
                    <div class="document-header">
                        <span class="document-type">${doc.type}</span>
                        <button class="delete-btn" onclick="deleteDocument(${doc.id}, '${doc.file_path}')">X</button>
                    </div>
                    <div class="document-title">${doc.title}</div>
                    <div class="document-author">${doc.author}</div>
                    <a href="${doc.file_url}" download="${doc.title}.${doc.file_url.split('.').pop()}" target="_blank" class="btn-secondary" style="margin-top: 15px; display: block; text-align: center;">Download</a>
                </div>
            `).join('');
        }

        async function deleteDocument(id, filePath) {
            if (!confirm('Tem certeza que deseja deletar este documento?')) {
                return;
            }

            // Primeiro, deleta o arquivo do Storage
            const { error: storageError } = await supabase.storage
                .from('documentfiles') // Nome do seu bucket de documentos
                .remove([filePath]);

            if (storageError) {
                console.error('Erro ao deletar arquivo do Storage:', storageError.message);
                alert('Erro ao deletar arquivo do Storage. Verifique as permiss√µes do bucket.');
                return;
            }

            // Depois, deleta o registro do banco de dados
            const { error: dbError } = await supabase
                .from('documents') // Nome da sua tabela de documentos
                .delete()
                .eq('id', id);

            if (dbError) {
                console.error('Erro ao deletar documento do banco de dados:', dbError.message);
                alert('Erro ao deletar documento do banco de dados. Verifique as permiss√µes da tabela.');
            } else {
                alert('Documento deletado com sucesso!');
                fetchAndRenderDocuments(); // Re-renderiza os documentos
            }
        }

        // Fun√ß√µes para clientes
        async function saveClient() {
            const name = document.getElementById('clientName').value;
            const email = document.getElementById('clientEmail').value;
            const phone = document.getElementById('clientPhone').value;
            const biLink = document.getElementById('clientBiLink').value; // NOVO: Link do BI
            
            let logoUrl = null;
            let logoPath = null;

            console.log("---------------------------------------");
            console.log("Iniciando saveClient...");
            console.log("Nome do Cliente:", name);
            console.log("Email do Cliente:", email);
            console.log("Telefone do Cliente:", phone);
            console.log("Link do BI do Cliente:", biLink); // NOVO: Log do link do BI
            

            if (name && email && phone) {
                // Tentativa de obter o input do logo aqui, ap√≥s a valida√ß√£o inicial dos campos
                const logoFileInput = document.getElementById('clientLogo'); 
                
                // DEPURANDO: Verifique se o elemento 'clientLogo' √© encontrado.
                console.log("Elemento 'clientLogo' encontrado?", logoFileInput); 

                // Adi√ß√£o da verifica√ß√£o: Apenas tenta fazer upload se o elemento e o arquivo existirem
                if (logoFileInput && logoFileInput.files && logoFileInput.files[0]) {
                    const logoFile = logoFileInput.files[0]; 
                    console.log("Arquivo do logo (obtido do input):", logoFile);

                    if (logoFile) { 
                        console.log("Arquivo de logo detectado.");
                        const logoFilePath = `logos/${Date.now()}_${logoFile.name}`;
                        console.log("Caminho do upload no Storage:", logoFilePath);
                        
                        const { data: uploadData, error: uploadError } = await supabase.storage
                            .from('clientlogos') 
                            .upload(logoFilePath, logoFile);

                        if (uploadError) {
                            console.error('Erro ao fazer upload do logo:', uploadError.message);
                            alert('Erro ao fazer upload do logo. Verifique as permiss√µes do bucket e o console.');
                            return; // Sair da fun√ß√£o se o upload falhar
                        }
                        
                        logoUrl = `${SUPABASE_URL}/storage/v1/object/public/clientlogos/${logoFilePath}`;
                        logoPath = logoFilePath;
                        console.log("Upload do logo bem-sucedido. URL P√∫blica:", logoUrl);
                    } else {
                        console.log("Nenhum arquivo de logo selecionado (input vazio). 'logoUrl' permanecer√° nulo.");
                    }
                } else {
                    console.warn("Elemento 'clientLogo' n√£o encontrado ou nenhum arquivo selecionado. O cliente ser√° salvo sem logo.");
                    // alert("Erro interno: O campo de sele√ß√£o de logo n√£o foi encontrado. Por favor, recarregue a p√°gina e tente novamente.");
                    // N√£o dar return aqui, para que o cliente possa ser salvo mesmo sem o logo, se a inten√ß√£o for essa.
                    // Se o logo for OBRIGAT√ìRIO, adicione `return;` aqui.
                }


                // Salva o cliente
                console.log("Tentando inserir cliente no banco de dados com logo_url:", logoUrl, "e bi_link:", biLink);
                const { data: clientData, error: clientError } = await supabase
                    .from('clients') 
                    .insert([
                        { name, email, phone, logo_url: logoUrl, logo_path: logoPath, bi_link: biLink } // NOVO: Salva bi_link
                    ])
                    .select(); 

                if (clientError) {
                    console.error('Erro ao salvar cliente no banco de dados:', clientError.message);
                    alert('Erro ao salvar cliente. Verifique as permiss√µes da tabela e o console.');
                    return;
                }

                const clientId = clientData[0].id;
                console.log("Cliente salvo com sucesso! ID:", clientId);

                // Salva os produtos
                if (currentProducts.length > 0) {
                    console.log("Produtos detectados. Tentando salvar produtos...");
                    const productsToInsert = currentProducts.map(p => ({
                        client_id: clientId,
                        name: p.name,
                        quantity: p.quantity
                    }));
                    const { error: productsError } = await supabase
                        .from('products') 
                        .insert(productsToInsert);

                    if (productsError) {
                        console.error('Erro ao salvar produtos:', productsError.message);
                        alert('Cliente salvo, mas erro ao salvar produtos. Verifique as permiss√µes da tabela de produtos.');
                    } else {
                         console.log("Produtos salvos com sucesso!");
                    }
                } else {
                    console.log("Nenhum produto para salvar.");
                }
                
                alert('Cliente salvo com sucesso!');
                // Limpar formul√°rio
                document.getElementById('clientName').value = '';
                document.getElementById('clientEmail').value = '';
                document.getElementById('clientPhone').value = '';
                document.getElementById('clientBiLink').value = ''; // NOVO: Limpa o link do BI
                // Verifica novamente se logoFileInput n√£o √© null antes de tentar limpar o valor
                if (logoFileInput) { 
                    logoFileInput.value = ''; 
                }
                document.getElementById('logoPreview').innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
                    <p>Clique para adicionar logo</p>
                `;
                currentProducts = [];
                updateProductsList('currentProducts', 'productsContainer');
                fetchAndRenderClients(); 
                showClientTab('view-clients'); 
                
            } else {
                console.log("Campos obrigat√≥rios do cliente n√£o preenchidos.");
                alert('Por favor, preencha todos os campos obrigat√≥rios do cliente.');
            }
            console.log("---------------------------------------");
        }

        async function fetchAndRenderClients() {
            const { data, error } = await supabase
                .from('clients')
                .select(`
                    *,
                    products (
                        id, name, quantity
                    )
                `);

            const container = document.getElementById('clientsList');

            if (error) {
                console.error('Erro ao buscar clientes:', error.message);
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>Erro ao carregar clientes.</p></div>`;
                return;
            }

            clients = data; // Atualiza a vari√°vel local com os dados do Supabase

            if (clients.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üë•</div>
                        <p>Nenhum cliente encontrado</p>
                        <p>Adicione clientes para come√ßar</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = clients.map(client => `
                <div class="client-card-vertical">
                    <div class="client-card-top">
                        <button class="delete-btn-card" onclick="deleteClient(${client.id}, '${client.logo_path || ''}')"><span style="font-size: 16px;">üóëÔ∏è</span></button>
                        <span class="client-status-card">Ativo</span>
                    </div>
                    <div class="client-logo-vertical">
                        ${client.logo_url ? `<img src="${client.logo_url}" alt="Logo" class="logo-preview-vertical">` : client.name.charAt(0).toUpperCase()}
                    </div>
                    <p class="add-logo-text">${client.logo_url ? '' : 'Adicionar Logo'}</p>
                    <h3 class="client-name-vertical">${client.name}</h3>
                    <p class="client-status-text">Cliente Ativo</p>
                    <div class="products-info-vertical">
                        <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 5px;">
                            <span style="font-size: 18px;">üì¶</span> <span style="font-weight: bold;">Produtos</span> (<span id="productCount-${client.id}">${client.products ? client.products.length : 0}</span>)
                        </div>
                        ${client.products && client.products.length > 0 ? client.products.map(p => `<p style="font-size: 14px; margin-left: 25px;">‚Ä¢ ${p.name} (x${p.quantity})</p>`).join('') : '<p style="font-size: 14px; color: rgba(255,255,255,0.6); margin-left: 25px;">Nenhum produto</p>'}
                    </div>
                    <button class="btn-vertical" onclick="viewClientDocuments(${client.id})">Ver Documentos</button>
                    <button class="btn-vertical edit" onclick="editClient(${client.id})">Editar Cliente</button>
                </div>
            `).join('');
        }
        
        async function deleteClient(id, logoPath) { // Agora espera logoPath
            if (!confirm('Tem certeza que deseja deletar este cliente e todos os seus produtos e documentos? Esta a√ß√£o √© irrevers√≠vel.')) {
                return;
            }

            // Se houver um logoPath, tenta delet√°-lo do Storage
            if (logoPath) {
                const { error: storageError } = await supabase.storage
                    .from('clientlogos') 
                    .remove([logoPath]);

                if (storageError) {
                    console.warn('Aviso: Erro ao deletar logo do Storage (pode n√£o existir ou caminho incorreto). Continuando com a exclus√£o do cliente no DB:', storageError.message);
                }
            }

            // Deleta o cliente (produtos e documentos associados ser√£o deletados via ON DELETE CASCADE se configurado no DB)
            const { error: dbError } = await supabase
                .from('clients') 
                .delete()
                .eq('id', id);

            if (dbError) {
                console.error('Erro ao deletar cliente do banco de dados:', dbError.message);
                alert('Erro ao deletar cliente do banco de dados. Verifique as permiss√µes da tabela ou as regras ON DELETE CASCADE.');
            } else {
                alert('Cliente deletado com sucesso!');
                fetchAndRenderClients(); 
            }
        }

        async function editClient(clientId) {
            const clientToEdit = clients.find(c => c.id === clientId);

            if (!clientToEdit) {
                alert('Cliente n√£o encontrado para edi√ß√£o.');
                return;
            }

            // Preenche o formul√°rio de edi√ß√£o
            document.getElementById('editClientId').value = clientToEdit.id;
            document.getElementById('editClientName').value = clientToEdit.name;
            document.getElementById('editClientEmail').value = clientToEdit.email;
            document.getElementById('editClientPhone').value = clientToEdit.phone;
            document.getElementById('editClientBiLink').value = clientToEdit.bi_link || ''; // NOVO: Preenche o link do BI

            const editLogoPreview = document.getElementById('editLogoPreview');
            if (clientToEdit.logo_url) {
                editLogoPreview.innerHTML = `<img src="${clientToEdit.logo_url}" class="logo-preview" alt="Logo preview">`;
            } else {
                editLogoPreview.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
                    <p>Clique para adicionar logo</p>
                `;
            }

            // Carrega os produtos existentes para a edi√ß√£o
            editingProducts = clientToEdit.products ? [...clientToEdit.products] : [];
            updateProductsList('editingProducts', 'editProductsContainer');

            // Exibe a aba de edi√ß√£o
            showClientTab('edit-client-tab');
        }

        async function updateClient() {
            const clientId = document.getElementById('editClientId').value;
            const name = document.getElementById('editClientName').value;
            const email = document.getElementById('editClientEmail').value;
            const phone = document.getElementById('editClientPhone').value;
            const biLink = document.getElementById('editClientBiLink').value; // NOVO: Pega o link do BI
            const logoFileInput = document.getElementById('editClientLogo');
            const newLogoFile = logoFileInput.files[0];

            if (!name || !email || !phone) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }

            let logoUrl = null;
            let logoPath = null;
            const currentClient = clients.find(c => c.id == clientId);

            // 1. Lidar com o upload/atualiza√ß√£o do logo
            if (newLogoFile) {
                // Se um novo arquivo foi selecionado, fa√ßa o upload e atualize
                const newLogoPath = `logos/${Date.now()}_${newLogoFile.name}`;
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('clientlogos') 
                    .upload(newLogoPath, newLogoFile);

                if (uploadError) {
                    console.error('Erro ao fazer upload do novo logo:', uploadError.message);
                    alert('Erro ao fazer upload do novo logo.');
                    return;
                }
                logoUrl = `${SUPABASE_URL}/storage/v1/object/public/clientlogos/${newLogoPath}`;
                logoPath = newLogoPath;

                // Se havia um logo antigo, tente delet√°-lo do Storage
                if (currentClient && currentClient.logo_path) {
                    const { error: deleteOldLogoError } = await supabase.storage
                        .from('clientlogos')
                        .remove([currentClient.logo_path]);
                    if (deleteOldLogoError) {
                        console.warn('Aviso: Erro ao deletar logo antigo do Storage:', deleteOldLogoError.message);
                    }
                }
            } else {
                // Se nenhum novo arquivo foi selecionado, manter o logo existente (se houver)
                if (currentClient) {
                    logoUrl = currentClient.logo_url;
                    logoPath = currentClient.logo_path;
                }
            }

            // 2. Atualizar os dados do cliente no banco de dados
            const { error: clientError } = await supabase
                .from('clients')
                .update({ name, email, phone, logo_url: logoUrl, logo_path: logoPath, bi_link: biLink }) // NOVO: Atualiza bi_link
                .eq('id', clientId);

            if (clientError) {
                console.error('Erro ao atualizar cliente no banco de dados:', clientError.message);
                alert('Erro ao atualizar cliente.');
                return;
            }

            // 3. Atualizar os produtos associados: Deletar os antigos e inserir os novos
            // Primeiro, deleta todos os produtos associados a este cliente
            const { error: deleteProductsError } = await supabase
                .from('products')
                .delete()
                .eq('client_id', clientId);

            if (deleteProductsError) {
                console.error('Erro ao deletar produtos antigos:', deleteProductsError.message);
                alert('Cliente atualizado, mas erro ao limpar produtos antigos.');
                // Pode continuar, pois o cliente j√° foi atualizado
            }

            // Depois, insere os produtos da lista de edi√ß√£o
            if (editingProducts.length > 0) {
                const productsToInsert = editingProducts.map(p => ({
                    client_id: parseInt(clientId), // Garante que √© um n√∫mero
                    name: p.name,
                    quantity: p.quantity
                }));
                const { error: insertProductsError } = await supabase
                    .from('products')
                    .insert(productsToInsert);

                if (insertProductsError) {
                    console.error('Erro ao inserir novos produtos:', insertProductsError.message);
                    alert('Cliente atualizado, mas erro ao adicionar novos produtos.');
                }
            }

            alert('Cliente atualizado com sucesso!');
            // Limpa o input de arquivo do logo de edi√ß√£o
            logoFileInput.value = ''; 
            editingProducts = []; // Limpa a lista de produtos de edi√ß√£o
            fetchAndRenderClients(); // Re-renderiza a lista de clientes
            showClientTab('view-clients'); // Volta para a visualiza√ß√£o de clientes
        }


        async function addClientDocument(clientId) {
            const title = document.getElementById('clientDocumentTitle').value;
            const type = document.getElementById('clientDocumentType').value;
            const fileInput = document.getElementById('clientDocumentFile');
            const file = fileInput.files[0];

            if (title && type && file) {
                const filePath = `client_documents/${clientId}/${Date.now()}_${file.name}`;
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('clientdocumentfiles') 
                    .upload(filePath, file);

                if (uploadError) {
                    console.error('Erro ao fazer upload do arquivo do cliente:', uploadError.message);
                    alert('Erro ao fazer upload do documento do cliente. Verifique as permiss√µes do bucket.');
                    return;
                }

                const publicURL = `${SUPABASE_URL}/storage/v1/object/public/clientdocumentfiles/${filePath}`;

                const { data, error } = await supabase
                    .from('client_documents') 
                    .insert([
                        { client_id: clientId, title, type, file_url: publicURL, file_path: filePath }
                    ]);

                if (error) {
                    console.error('Erro ao adicionar documento do cliente no banco de dados:', error.message);
                    alert('Erro ao adicionar documento do cliente. Verifique as permiss√µes da tabela.');
                } else {
                    alert('Documento do cliente adicionado com sucesso!');
                    // Limpar formul√°rio
                    document.getElementById('clientDocumentTitle').value = '';
                    document.getElementById('clientDocumentType').value = '';
                    fileInput.value = '';
                    fetchAndRenderClientDocuments(clientId); 
                }
            } else {
                alert('Por favor, preencha todos os campos e selecione um arquivo para o documento do cliente.');
            }
        }

        async function fetchAndRenderClientDocuments(clientId) {
            const { data, error } = await supabase
                .from('client_documents') 
                .select('*')
                .eq('client_id', clientId);

            const container = document.getElementById('clientDocumentsList');

            if (error) {
                console.error('Erro ao buscar documentos do cliente:', error.message);
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>Erro ao carregar documentos do cliente.</p></div>`;
                return;
            }

            if (data.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÅ</div>
                        <p>Nenhum documento para este cliente.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = data.map(doc => `
                <div class="document-card">
                    <div class="document-header">
                        <span class="document-type">${doc.type}</span>
                        <button class="delete-btn" onclick="deleteClientDocument(${doc.id}, '${doc.file_path}', ${clientId})">X</button>
                    </div>
                    <div class="document-title">${doc.title}</div>
                    <div class="document-author">ID do Cliente: ${doc.client_id}</div>
                    <a href="${doc.file_url}" download="${doc.title}.${doc.file_url.split('.').pop()}" target="_blank" class="btn-secondary" style="margin-top: 15px; display: block; text-align: center;">Download</a>
                </div>
            `).join('');
        }

        async function deleteClientDocument(documentId, filePath, clientId) {
            if (!confirm('Tem certeza que deseja deletar este documento do cliente?')) {
                return;
            }

            // Primeiro, deleta o arquivo do Storage
            const { error: storageError } = await supabase.storage
                .from('clientdocumentfiles') 
                .remove([filePath]);

            if (storageError) {
                console.error('Erro ao deletar arquivo do Storage do cliente:', storageError.message);
                alert('Erro ao deletar arquivo do Storage do cliente. Verifique as permiss√µes do bucket.');
                return;
            }

            // Depois, deleta o registro do banco de dados
            const { error: dbError } = await supabase
                .from('client_documents') 
                .delete()
                .eq('id', documentId);

            if (dbError) {
                console.error('Erro ao deletar documento do cliente do banco de dados:', dbError.message);
                alert('Erro ao deletar documento do cliente do banco de dados. Verifique as permiss√µes da tabela.');
            } else {
                alert('Documento do cliente deletado com sucesso!');
                fetchAndRenderClientDocuments(clientId); 
            }
        }

        // NOVO: Fun√ß√µes para a aba de Dashboards
        async function fetchAndRenderDashboards() {
            const { data, error } = await supabase
                .from('clients')
                .select('id, name, logo_url, bi_link') // Seleciona apenas o necess√°rio
                .not('bi_link', 'is', null) // Apenas clientes que t√™m um link de BI
                .not('bi_link', 'eq', ''); // E que o link n√£o seja vazio

            const container = document.getElementById('dashboardsList');

            if (error) {
                console.error('Erro ao buscar dashboards:', error.message);
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ùå</div><p>Erro ao carregar dashboards.</p></div>`;
                return;
            }

            if (data.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <p>Nenhum Dashboard de cliente encontrado.</p>
                        <p>Adicione clientes com links de BI para visualiz√°-los aqui.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = data.map(client => `
                <div class="dashboard-card">
                    <div class="client-logo-vertical">
                        ${client.logo_url ? `<img src="${client.logo_url}" alt="Logo" class="logo-preview-vertical">` : client.name.charAt(0).toUpperCase()}
                    </div>
                    <h3>${client.name}</h3>
                    <a href="${client.bi_link}" target="_blank" class="btn-bi">
                        <i class="fas fa-external-link-alt"></i> Acessar
                    </a>
                </div>
            `).join('');
        }


        // O c√≥digo dentro deste bloco s√≥ ser√° executado quando o DOM estiver completamente carregado.
        document.addEventListener('DOMContentLoaded', () => {
            showTab('documents'); // Agora "Time de Implanta√ß√£o" √© a aba padr√£o ao carregar
        });
    </script>
</body>
</html>
